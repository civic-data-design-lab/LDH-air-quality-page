<!doctype html>
<html class="no-js" lang="">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie-edge">
		<title></title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style>
		.card {
		  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
		  transition: 0.3s;
		  border-radius: 30px;
		  text-align: center;
		  /*margin-top: 125px;*/
		  padding-bottom: 50px;
		}

		.container {
		  padding: 2px 16px;
		}

		.center {
		  display: block;
		  margin-left: auto;
		  margin-right: auto;
/*		  width: 50%;
*/		}

		.arrow {
			width: auto;
			height: 7.5%;
			display: inline-block;
			top: 45%;
			position: fixed;
			opacity: 0.2;
			z-index: 999
		}

		.arrow:hover {
			display: inline-block;
			top: 45%;
			position: fixed;
			opacity: 1;
			z-index: 999;
			cursor: pointer;
		}

		body {
			font-family: "Helvetica Neue", Helvetica;
			font-weight: 300;
		}


		h4 {
			font-size: 32px;
			font-size: 2vw;
		}

		p {
			font-size: 64px;
			font-size: 4vw;
		}

		.block {
			height: 30px;
			width: 100%;
		}

		.background {
			opacity: 0;
		}

		</style>
		<script src="https://apis.google.com/js/api.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	</head>
	<body>
		<script defer>

			function aqiFromPM(pm) {

			      if (isNaN(pm)) return "-"; 
			      if (pm == undefined) return "-";
			      if (pm < 0) return pm; 
			      if (pm > 1000) return "-"; 
			        /*      
			              Good                              0 - 50         0.0 - 15.0         0.0 – 12.0
			        Moderate                        51 - 100           >15.0 - 40        12.1 – 35.4
			        Unhealthy for Sensitive Groups   101 – 150     >40 – 65          35.5 – 55.4
			        Unhealthy                                 151 – 200         > 65 – 150       55.5 – 150.4
			        Very Unhealthy                    201 – 300 > 150 – 250     150.5 – 250.4
			        Hazardous                                 301 – 400         > 250 – 350     250.5 – 350.4
			        Hazardous                                 401 – 500         > 350 – 500     350.5 – 500
			        */
			        if (pm > 350.5) {
			          return calcAQI(pm, 500, 401, 500, 350.5);
			        } else if (pm > 250.5) {
			          return calcAQI(pm, 400, 301, 350.4, 250.5);
			        } else if (pm > 150.5) {
			          return calcAQI(pm, 300, 201, 250.4, 150.5);
			        } else if (pm > 55.5) {
			          return calcAQI(pm, 200, 151, 150.4, 55.5);
			        } else if (pm > 35.5) {
			          return calcAQI(pm, 150, 101, 55.4, 35.5);
			        } else if (pm > 12.1) {
			          return calcAQI(pm, 100, 51, 35.4, 12.1);
			        } else if (pm >= 0) {
			          return calcAQI(pm, 50, 0, 12, 0);
			        } else {
			          return undefined;
			        }
			      
			      }
			      function bplFromPM(pm) {
			      if (isNaN(pm)) return 0; 
			      if (pm == undefined) return 0;
			      if (pm < 0) return 0; 
			        /*      
			              Good                              0 - 50         0.0 - 15.0         0.0 – 12.0
			        Moderate                        51 - 100           >15.0 - 40        12.1 – 35.4
			        Unhealthy for Sensitive Groups   101 – 150     >40 – 65          35.5 – 55.4
			        Unhealthy                                 151 – 200         > 65 – 150       55.5 – 150.4
			        Very Unhealthy                    201 – 300 > 150 – 250     150.5 – 250.4
			        Hazardous                                 301 – 400         > 250 – 350     250.5 – 350.4
			        Hazardous                                 401 – 500         > 350 – 500     350.5 – 500
			        */
			        if (pm > 350.5) {
			        return 401;
			        } else if (pm > 250.5) {
			        return 301;
			        } else if (pm > 150.5) {
			        return 201;
			        } else if (pm > 55.5) {
			        return 151;
			        } else if (pm > 35.5) {
			        return 101;
			        } else if (pm > 12.1) {
			        return 51;
			        } else if (pm >= 0) {
			        return 0;
			        } else {
			        return 0;
			        }
			      
			      }
			      function bphFromPM(pm) {
			      //return 0;
			      if (isNaN(pm)) return 0; 
			      if (pm == undefined) return 0;
			      if (pm < 0) return 0; 
			        /*      
			              Good                              0 - 50         0.0 - 15.0         0.0 – 12.0
			        Moderate                        51 - 100           >15.0 - 40        12.1 – 35.4
			        Unhealthy for Sensitive Groups   101 – 150     >40 – 65          35.5 – 55.4
			        Unhealthy                                 151 – 200         > 65 – 150       55.5 – 150.4
			        Very Unhealthy                    201 – 300 > 150 – 250     150.5 – 250.4
			        Hazardous                                 301 – 400         > 250 – 350     250.5 – 350.4
			        Hazardous                                 401 – 500         > 350 – 500     350.5 – 500
			        */
			        if (pm > 350.5) {
			        return 500;
			        } else if (pm > 250.5) {
			        return 500;
			        } else if (pm > 150.5) {
			        return 300;
			        } else if (pm > 55.5) {
			        return 200;
			        } else if (pm > 35.5) {
			        return 150;
			        } else if (pm > 12.1) {
			        return 100;
			        } else if (pm >= 0) {
			        return 50;
			        } else {
			        return 0;
			        }
			      
			      }
			 
			      function calcAQI(Cp, Ih, Il, BPh, BPl) {
			      
			        var a = (Ih - Il);
			        var b = (BPh - BPl);
			        var c = (Cp - BPl);
			        return Math.round((a/b) * c + Il);
			      
			      }
			 
			 
			      function getAQIDescription(aqi) {
			        if (aqi >= 401) {
			          return 'Hazardous';
			        } else if (aqi >= 301) {
			          return 'Hazardous';
			        } else if (aqi >= 201) {
			          return 'Very Unhealthy';
			        } else if (aqi >= 151) {
			          return 'Unhealthy';
			        } else if (aqi >= 101) {
			          return 'Unhealthy for Sensitive Groups';
			        } else if (aqi >= 51) {
			          return 'Moderate';
			        } else if (aqi >= 0) {
			          return 'Good';
			        } else {
			          return undefined;
			        }
			      }
			 
			      function getAQIMessage(aqi) {
			        if (aqi >= 401) {
			          return 'Health alert: everyone may experience more serious health effects';
			        } else if (aqi >= 301) {
			          return 'Health alert: everyone may experience more serious health effects';
			        } else if (aqi >= 201) {
			          return 'Health warnings of emergency conditions. The entire population is more likely to be affected. ';
			        } else if (aqi >= 151) {
			          return 'Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.';
			        } else if (aqi >= 101) {
			          return 'Members of sensitive groups may experience health effects. The general public is not likely to be affected.';
			        } else if (aqi >= 51) {
			          return 'Air quality is acceptable; however, for some pollutants there may be a moderate health concern for a very small number of people who are unusually sensitive to air pollution.';
			        } else if (aqi >= 0) {
			          return 'Air quality is considered satisfactory, and air pollution poses little or no risk';
			        } else {
			          return undefined;
			        }
			     }

			     function getAQIOpacity(aqi) {
			     	if (aqi >= 401) {
			     	  return 0.95;
			     	} else if (aqi >= 301) {
			     	  return 0.8;
			     	} else if (aqi >= 201) {
			     	  return 0.7;
			     	} else if (aqi >= 151) {
			     	  return 0.6;
			     	} else if (aqi >= 101) {
			     	  return 0.5;
			     	} else if (aqi >= 51) {
			     	  return 0.3;
			     	} else if (aqi >= 0) {
			     	  return 0;
			     	} else {
			     	  return undefined;
			     	}
			     }

			fetch('https://sheets.googleapis.com/v4/spreadsheets/1EG53Isa_H-kZoxy8E2-8sUKl2GnXlJBah-I8jc2RPaI/values/A2:J?key=AIzaSyBprW4Fs6iOnaNO6WQt2DMQw7hda8_PhnI').then(response => response.json()).then(res => {
				console.log(res);
				console.log(res['values'][0]);

				var labels = []
				var data_vals = [];

				// get values from spreadsheet
				var vals = res["values"];

				// only take pm25 readings
				vals = vals.filter(row => row[5] === 'pm25');

				// filter out values not from the last day
				const last_day = new Date(vals[vals.length - 1][0]) ;

				var dateOffset = (24*60*60*1000) * 1 / 24 * 3; // 3 hour in ms
				var oldestDate = new Date();
				oldestDate.setTime(last_day.getTime() - dateOffset);
				console.log(oldestDate.toISOString());
				console.log(last_day.toISOString());

				vals = vals.filter(row => new Date(row[0]).getTime() > oldestDate.getTime());

				for (const val of vals) {
					data_vals.push(val[6]);
					date = new Date(val[0]);
					labels.push(date.toLocaleTimeString());
				}


				var total = 0;
				for (var i = 0; i < data_vals.length; i++) {
					total += parseFloat(data_vals[i]);
				}
				console.log(total);
				var avg = total / data_vals.length;
				console.log(avg);

				var AQI = aqiFromPM(avg);
				var AQIDescription = getAQIDescription(AQI); //A short description of the provided AQI
				var AQIMessage = getAQIMessage(AQI); // What the provided AQI means (a longer description)

				console.log(AQI);
				console.log(AQIDescription);
				console.log(AQIMessage);

				var percent = Math.min((AQI / 500 + 0.25) * 100, 100);
				console.log(percent);

				document.getElementById("needle").style.left= percent.toString() + "%";
				document.getElementById("advisory").innerHTML = AQIMessage;
				document.getElementById("message").innerHTML = AQIDescription;

				var new_opacity = getAQIOpacity(AQI);

				// console.log('new opacity ' + new_opacity);

				document.getElementById("haze").style = "position:absolute; top:0; left:25%; border-radius:5px; opacity:" + new_opacity

				// labels.forEach(function (label, i) {
				// if (i % 20 != 0) labels[i] = '';// show empty string
				// });

				const down = (ctx, value) => (ctx.p0.parsed.y > 12 | ctx.p1.parsed.y > 12) ? value : undefined;

				const data = {
				  labels: labels,
				  datasets: [{
				    label: 'PM2.5 Concentration',
				    backgroundColor: 'rgb(106, 168, 79)',
				    borderColor: 'rgb(106, 168, 79)',
				    borderWidth: 1,
				    radius: 0,
				    data: data_vals,
				    segment: {
				    	borderColor: ctx => down(ctx, 'rgb(255,229,153)')
				    }
				  }],
				};


				const config = {
				  type: 'line',
				  data: data,
				  options: {
				  	plugins: {
				  	    legend: false,
				  	},
				  	scales: {
			  	            x: {
			  	                ticks: {
			  	                    // Include a dollar sign in the ticks
			  	                    // callback: function(value, index, values) {
			  	                    //     return '$' + value;
			  	                    // },
			  	                    autoSkip: true,
		  	        	        },
		  	        	        title: {
		  	        	        	display: true,
		  	        	        	text: 'Time'
		  	        	        }
		  	            	},
		  	            	y: {
                            	title: {
                            		display: true,
                            		text: 'PM2.5 Concentration',
                            	}
		  	            	}
				  	    }
				  }
				};

				var myChart = new Chart(
				  document.getElementById('dailyGraph'),
				  config
				);

				});


		</script>
		<img src="assets/left-arrow.png" class="arrow" style="left:1%;" onClick="leftClick()">
		<img src="assets/right-arrow.png" class="arrow" style="right:1%;" onClick="rightClick()">
		<script defer>

			function init() {
				localStorage.setItem('page_num', 1);
				updatePageDisplay(1);
			}

			function updatePageDisplay(page_num) {
				const cards = ['today', 'recommendation', 'graph', 'info']
				cards.forEach(element => document.getElementById(element).style.display="none")
				switch (page_num) {
					case 1:
						document.getElementById(cards[0]).style.display="initial";
						break;
					case 2:
						document.getElementById(cards[1]).style.display="initial";
						break;
					case 3:
						document.getElementById(cards[2]).style.display="initial";
						break;
					case 4:
						document.getElementById(cards[3]).style.display="initial";
						break;
				}
			}

			function rightClick() {
				var page_num = localStorage.getItem('page_num');
				console.log('GOT', page_num)
				page_num = Math.min(+page_num + 1, 4);
				console.log('SETTING', page_num);
				localStorage.setItem('page_num', page_num);
				updatePageDisplay(page_num);
			}

			function leftClick() {
				var page_num = localStorage.getItem('page_num');
				page_num = Math.max(+page_num - 1, 1);
				console.log(page_num);
				localStorage.setItem('page_num', page_num);
				updatePageDisplay(page_num);
			}

		</script>

		<img src="assets/AQ_icon.png" class="center" width="25%" height="auto" max-width="50px" style="left:37.5%;">

		<div id="today">
			<div class="card">
			  <div class="container">
			    <h4><b>Today's Air Quality</b></h4> 
			    <p id="message"> </p> 
			  </div>

			  <div class="container" style="position:relative" margin-left="100px" margin-right="100px">
				<img src="assets/discrete_meter_labelled.png" width="50%" height="auto" style="position:absolute; top:0; left:25%;">
				<img src="assets/ball_needle.png" id="needle" width="5%" height="auto" style="position:absolute; top:0; left:50%;">
				<img class="background"src="assets/discrete_meter_labelled.png" width="50%" height="auto">
			  </div>


		</div>
			<div class="block"></div>
		</div>

		<div id="recommendation">
			<div class="card">
			  <div class="container">
			  	<h4><b>Daily Recommendation</b></h4>
			  </div>



			  <div class="container" style="position:relative" margin-left="100px" margin-right="100px">
				<img id="cityscape" src="assets/community.png" width="50%" height="auto" style="position:absolute; top:0; left:25%;">
				<img id='haze' src="assets/haze.png" width="50%" height="auto" style="position:absolute; top:0; left:25%; border-radius:5px">
				<img class="background"src="assets/community.png" width="50%" height="auto">
			  </div>

			  <div class="container">
			  	<div class="block"> </div>
			  	<p id="advisory">  </p>
			  </div>

			</div>

		</div>

		<div  id="graph">
			<div class="card">
			  <div class="container">
			  	<h4><b>Air quality in the last 3 hours</b></h4>
			  </div>

			  <div class="container" style="position:relative" margin-left="100px" margin-right="100px">
			  	<canvas id="dailyGraph"></canvas>
			  </div>

			</div>
		</div>

		<div id="info">
			<div class="card">
			  <div class="container">
			  	<h4><b>Learn More About Air Quality</b></h4>
			  	<p id="advisory">
			  		These advisories are based on a measurement called "AQI" or “Air Quality Index”. This measurement is calculated based on the number of extremely small particles (particulate matter) in the air.
			  		<br>
			  		<br>
			  		High levels of particulate matter have been shown to hurt human respiratory health. When the concentration of particulate matter is high outside, experts recommend staying indoors and limiting time spent outside.

			  	</p>
			  </div>
			</div>
		</div>

		<script>
			init();
		</script>

	</body>
</html>
